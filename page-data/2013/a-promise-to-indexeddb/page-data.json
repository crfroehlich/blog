{"componentChunkName":"component---src-templates-docs-js","path":"/2013/a-promise-to-indexeddb","result":{"data":{"site":{"siteMetadata":{"title":"Christopher Froehlich's Blog | Hiking My Desk","docsLocation":"https://github.com/crfroehlich/blog/tree/main/content"}},"mdx":{"fields":{"id":"7dd5c599-2016-5705-931f-86516bb740b9","title":"A Promise to IndexedDb","slug":"/2013/a-promise-to-indexeddb"},"body":"function _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"title\": \"A Promise to IndexedDb\",\n  \"metaTitle\": \"A Promise to IndexedDb\",\n  \"metaDate\": \"6/26/2013\",\n  \"metaDraft\": false,\n  \"aliases\": [\"/2013/06/a-promise-to-indexeddb.html\"]\n};\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, [\"components\"]);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"Quite a bit of my free time in the last 8 months has slipped away into\\xA0\", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"http://somecallmechief.github.io/oj/\"\n  }), \"OJ\"), \", my solution to the hell of dynamic form creation (based on arbitrary data inputs and accordingly arbitrary data outputs). Folks at \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"http://www.wufoo.com/\"\n  }), \"WuFoo\"), \" and \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://bootsnipp.com/index.php/forms\"\n  }), \"Bootsnip\"), \" have some nice prototypes of runtime manipulatable engines; while each looks like excellent work, neither solves my problem of generating entire workflows based on data. I want the data to drive the UI; the UI should simply read the data and generate the necessary rich form content necessary to provide slick, intuitive, addictive user experiences.\"), mdx(\"p\", null, \"In the pursuit of this heffalump, I had recently been working on decomposing\\xA0\", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"http://www.youtube.com/user/karnevalCom\"\n  }), \"Martin Orth\"), \"'s \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"http://www.youtube.com/watch?v=QJwlEry_ER4\"\n  }), \"query builder\"), \" into classes in the OJ framework (see it on \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://github.com/somecallmechief/oj\"\n  }), \"Github\"), \", in \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://npmjs.org/package/ojs\"\n  }), \"NPM\"), \", and collaborate with me in \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://c9.io/somecallmechief/oj\"\n  }), \"Cloud9\"), \"). This body of work depends upon \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"http://www.sencha.com/products/extjs\"\n  }), \"ExtJs\"), \", which is a powerful but extraordinarily inscrutable framework. I spend a frustrating amount of time comparing the inputs into Ext from OJ vs the inputs in Sencha's examples or their documentation. It's tedious and fragile as seeming minor changes can produce difficult to track bugs which go unobserved across several commits.\"), mdx(\"p\", null, \"I wanted to be able to instrument my code in such a way that I could flip a switch and start logging every input into Ext. I had a few requirements: the objects logged needed to be in as close a state as possible to their values at the time of logging (logging to the console sends the object by reference, so you'll usually get the last known value of the object by the time you see it). The objects needed to persist across page loads. There would be a lot of data (more than would fit in localStorage). Finally, the data needed to be queryable.\"), mdx(\"p\", null, mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://developer.mozilla.org/en-US/docs/IndexedDB%E2%80%8E\"\n  }), \"IndexedDb\"), \" seemed like a potentially good fit. Unfortunately, like so many \\\"HTML5\\\" standards, \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://developer.mozilla.org/en-US/docs/IndexedDB\"\n  }), \"the API is terrible\"), \". If the consumers of this API were just vendors, like Chrome and Firefox, it would be hard to identify any specific contract as \\\"wrong\\\"; but as a developer consuming this API, I cannot easily point to any component and say, \\\"this is right.\\\" But it is what it is, and it is all we've got.\"), mdx(\"p\", null, \"So in an effort to transmogrify the indexedDb API into something that I would actually want to use myself, I put together a proof-of-concept wrapped around \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"http://wiki.commonjs.org/wiki/Promises/A\"\n  }), \"Promises\"), \". I am developing it inside of OJ, but it could easily be factored out to use independently.\"), mdx(\"p\", null, \"You'll need:\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"https://github.com/kriskowal/q\"\n  }), \"Q.js\"), \" (\", mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"http://www.blogger.com/profile/01443956999129365941\"\n  }), \"Kris Kowal\"), \"'s excellent Promise library)\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"The \", mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"http://nparashuram.com/IndexedDBShim/\"\n  }), \"IndexedDb polyfill\"), \" (to support the IEs of the world, and such)\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"https://github.com/marak/Faker.js/%E2%80%8E\"\n  }), \"FakerJs\"), \" (Optional: very useful to get prototypes running without worrying about creating the data)\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"http://somecallmechief.github.io/oj/\"\n  }), \"OJ\"), \" (Optional: only if you don't want to have to factor out my helper methods)\")), mdx(\"p\", null, \"This is the API that I wanted to call:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js\"\n  }), \"var tableName = 'messages', dbName = 'diagnostics', dbVersion = 1;\\n\\n//Create a new DB manager instance\\nvar newDbMgr = initDb();\\n//Connect to a specific database\\nnewDbMgr.connect(dbName, dbVersion);\\n\\n//Create or extend a schema\\n//newDbMgr.ddl.dropTable(tableName);\\nnewDbMgr.ddl.createTable(tableName, 'messageid', true); //true == auto manage primary key\\nnewDbMgr.ddl.createIndex(tableName, 'subjectid', 'text.subject');\\nnewDbMgr.ddl.createIndex(tableName, 'timeid', 'time');\\nnewDbMgr.ddl.createIndex(tableName, 'usernameid', 'user.name');\\n\\n//Insert some data\\nnewDbMgr.insert(tableName, {message: { time: new Date(), text: { fault: Faker.Lorem.words(), subject: Faker.Lorem.sentence(), description: Faker.Lorem.paragraph() }, user: Faker.Helpers.createCard() } });\\nnewDbMgr.insert(tableName, {message: { time: new Date(), text: { fault: Faker.Lorem.words(), subject: Faker.Lorem.sentence(), description: Faker.Lorem.paragraph() }, user: Faker.Helpers.createCard() } });\\n\\n//Query the data\\nvar results = newDbMgr.select('message').from(tableName).where('user.name', '=', 'Bob');\\n\")), mdx(\"p\", null, \"To make it happen, some work needed to be done. First, you need a database connection. I never liked the implementation of \\\"versioning\\\" the database in WebSQL--but conceptually, it is the same mystery bag of disappointments in iDb; so the first step is to abstract and encapsulate the mechanism for opening a database connection and handling the version control events.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js\"\n  }), \"var initDb = (function() {\\n var name;\\n //Store the last used db name, db version and db connect promise in the closure\\n var version, db, connectPromise;\\n var reInit = false;\\n\\n //The actual connect method to be used in order to establish a connection and/or trigger versioning\\n var connect = function(dbName, dbVersion, dbOnUpgrade) {\\n  //Only create a new promise if connecting to a different db name or version; otherwise, the last issued promise is still good.\\n  reInit = (!connectPromise || dbName !== name || dbVersion !== version);\\n  if(reInit) {\\n   //Create a new promise from scratch\\n   var deferred = Q.defer();\\n\\n   //Cache our state data in the outer closure\\n   connectPromise = deferred.promise;\\n   version = dbVersion || 1;\\n   name = dbName;\\n   dbOnUpgrade = dbOnUpgrade || function() {};\\n\\n   //Create the connection request. This is an async operation, which the promise will resolve.\\n   var request = window.indexedDB.open(name, version);\\n\\n   //Optionally do something when the request is completed (with or without error)\\n   request.oncomplete = function () {\\n\\n            }\\n\\n   //Someone or something has explicitly aborted the request\\n            request.onabort = function () {\\n                window.console.error('Connection attempt to ' + name + ' was aborted. Closing db connection now.');\\n                db.close();\\n            }\\n\\n   //Connection has timed out\\n            request.ontimeout = function () {\\n    window.console.error('Connection attempt to ' + name + ' timed out. Closing db connection now.');\\n                db.close();\\n            }\\n\\n   //Another process has a lock on the database\\n   request.onblocked = function(event) {\\n    //Resolve the promise with rejection\\n    deferred.reject(new Error(\\\"Database error: \\\" + event.target.errorCode));\\n    window.console.error('Connection attempt to ' + name + ' was blocked by another process. Is the db open in another window/tab? Did you forget to close your connection to the db before attempting to version it? Closing db connection now.');\\n    db.close();\\n   };\\n\\n   //An error occurred at any time during the lifecycle of the request.\\n   request.onerror = function(event) {\\n    //Resolve the promise with rejection\\n    deferred.reject(new Error(\\\"Database error: \\\" + event.target.errorCode));\\n    window.console.error('Connection to ' + name + ' failed with error: ' + event.target.errorCode + '. Closing db connection now.');\\n    if(db) {\\n     db.close();\\n    }\\n   };\\n\\n   //Versioning happens before success (promise is not yet resolved, but we have a handle on the db instance)\\n   request.onupgradeneeded = function(event) {\\n    db = event.target.result;\\n\\n    dbOnUpgrade(db);\\n   };\\n\\n   //Request has succeeded; versioning may or may not have happened; connection to the database is established\\n   request.onsuccess = function(event) {\\n    db = request.result;\\n    //Resolve the promise with success and the db instance\\n    deferred.resolve(db);\\n   };\\n  }\\n\\n  //Return either the new promise or the existing\\n  return connectPromise;\\n };\\n\\n //More code to follow\\n ....\\n}());\\n\")), mdx(\"p\", null, \"Hopefully the commentary in the code is sufficient to communicate its meaning. In essence, I'm leveraging Q's deferred promise wrapper against the resolution of the iDb request's async callbacks. Of course, if indexedDb simply implemented its many cascading callbacks as promises, this post might not exist.\"), mdx(\"p\", null, \"Once the connection wrapper is defined, I can encapsulate some of the DDL operations into this new API.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js\"\n  }), \"//private implementation method\\nvar createTableImpl = function(dbWrapper, db, tableName, tablePkColumnName, autoIncrement) {\\n //The call to createObjectStore is synchronous--the table is immediately returned\\n var table = db.createObjectStore(tableName, { keyPath: tablePkColumnName, autoIncrement: false !== autoIncrement });\\n //Cache the table instance for future reference\\n dbWrapper.schema.add(tableName, table);\\n return table;\\n};\\n\\n//public method. DDL operations can only happen as part of the versioning event.\\n//Add the call to create the table to a schema scripts collection which the IndexedDb versioner will iterate.\\nvar createTable = function(dbWrapper, tableName, tablePkColumnName, autoIncrement) {\\n //Create a new promise\\n var deferred = Q.defer();\\n //Push this method into the scripts collection\\n schemaScripts.push(function(db) {\\n  try {\\n   //Create the table\\n   var objectStore = createTableImpl(dbWrapper, db, tableName, tablePkColumnName, autoIncrement);\\n   //Resolve the promise successful with the table\\n   deferred.resolve(objectStore);\\n\\n  } catch(e) {\\n   console.log(e, e.stack);\\n   //Resolve the promise failed\\n   deferred.reject(new Error('Could not create a new table', e));\\n  }\\n  return dbWrapper.schema\\\\[tableName\\\\];\\n });\\n return deferred.promise;\\n};\\n\")), mdx(\"p\", null, \"If you return to my dream API above, you'll notice that I placed the DDL operations first. Because this implementation uses promises, the order of operations is extraordinarily flexible. I could just as easily position the calls to DDL operations after a long list of calls to DML operations, and the Q promise layer would just make it work. This is in stark contrast to the iDb event model which is highly dependent upon the execution of functions being in the right place at the right time. Promises allow me, as a developer, to think less about the coordination of sequencing to/from other APIs and more about the order I want my own code to execute.\"), mdx(\"p\", null, \"At any rate, the above is just enough to create some indexedDb tables. Next, the core of indexedDb: \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"http://grammarist.com/usage/indexes-indices/\"\n  }), \"indexes\"), \".\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js\"\n  }), \"//Private implementation method\\nvar createIndexImpl = function(dbWrapper, tableName, columnName, indexName, isUnique) {\\n //No need to wait on transaction, we have (or should have) the table in memory\\n var table = dbWrapper.schema\\\\[tableName\\\\];\\n //Create the new index and return it immediately (happens synchronously)\\n //It would be nice to cache the index on the cached table instance, but that table instance is actually an indexedDb object and I don't want to mutate--nor do I want to refactor anything at the moment. So eat the cost of fetching a handle on indexes later. Told-you-so's expected.\\n return table.createIndex(columnName, indexName || columnName + 'Idx', { unique: true !== isUnique });\\n};\\n\\n//public method. DDL operations can only happen as part of the versioning event.\\n//Add the call to create the index to a schema scripts collection which the IndexedDb versioner will iterate.\\nvar createIndex = function(dbWrapper, tableName, columnName, indexName, isUnique) {\\n //Create a new promise\\n var deferred = Q.defer();\\n //Push this method into the scripts collection\\n schemaScripts.push(function() {\\n  try {\\n   var index = createIndexImpl(dbWrapper, tableName, columnName, indexName, isUnique);\\n   //Resolve the promise successful with the new index\\n   deferred.resolve(index);\\n\\n  } catch(e) {\\n   console.log(e, e.stack);\\n   //Fail the promise\\n   deferred.reject(new Error('Could not create a new index', e));\\n  }\\n  return dbWrapper.schema\\\\[tableName\\\\];\\n });\\n return deferred.promise;\\n};\\n\")), mdx(\"p\", null, \"Very much like the createTable method before it, the createIndex method hooks into the schema scripts collection and executes on the db versioning event. Unlike WebSQL or SQLite, IndexedDb is designed to be a non-necessarily-relational \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"object\"), \" store. So it stores \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"objects\"), \". Objects can be primitive values, arrays or complex Object instances with deeply nested, non-relational tree structures. Indexes are levied against the property names of the values you want to be indexed.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js\"\n  }), \"var obj = {\\n    str: '',\\n    num: 0,\\n    arr: \\\\[\\\\],\\n    obj1: {\\n        str1: '',\\n        obj2: {\\n            str2: ''\\n        }\\n    }\\n}\\n\")), mdx(\"p\", null, \"So an index on \\\"str2\\\" is as simple as defining an index on \\\"obj1.obj2.str2\\\". This took me quite a bit of trial and error, so I think it's worth highlighting how the pathing to an index works.\"), mdx(\"p\", null, \"Finally (for the purpose of this post), you need a way to insert data into the store.\\xA0\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js\"\n  }), \"//Private implementation method, doesn't yet conform to standard \\\\*Impl paradigm. It's ok; I'm ok; you're ok.\\nvar insertImpl = function(tableName, records) {\\n //Promise to insert the data\\n var deferred = Q.defer();\\n\\n try {\\n  //Get a new transaction on the table. This is an insert, so 'readwrite' is implicitly understood by the caller.\\n  var transaction = db.transaction(\\\\[tableName\\\\], 'readwrite');\\n\\n  //Get the object store from the transaction (gods forbid we fetched it from our own handle on the object store...and how the hell does this thing manage concurrency?!)\\n  var objectStore = transaction.objectStore(tableName);\\n  //Insert the new records\\n  n$.each(records, function(rec) {\\n   objectStore.add(rec);\\n  });\\n  //Resolve the promise\\n  deferred.resolve(true);\\n } catch(e) {\\n  console.log(e, e.stack);\\n  //Fail the promise\\n  deferred.reject(new Error('Could not insert records',e));\\n }\\n //Return the promise\\n return deferred.promise;\\n};\\n\\n//Public insert method\\nvar insert = function(tableName, records) {\\n var ret = function() {\\n  return insertImpl(tableName, records);\\n };\\n //If we have a db instance or if the initial connection promise is resolved (succeeded), then it is safe to insert immediately\\n if(db || connectPromise.isResolved()) {\\n  ret();\\n } else { //else wait for the connection promise to resolve and then do the insert (this seems to be the normal use case)\\n  connectPromise.then(ret);\\n }\\n //Nothing worth returning at this time\\n //return ret.promise;\\n};\\n\")), mdx(\"p\", null, \"I still have to put the finishing touches on some more of this API. Transactions become a bigger deal as you begin to write more complicated queries, and indexes (and their cursors) play a much, much larger role than I have touched upon here; but I think that this provides one alternative to the problem of working with indexedDb that is simple.\"), mdx(\"p\", null, \"This whole abstraction needs to be lazy, and there is another round of refactoring I need to do to move it into a pure functional style; but I think it is more readable and approachable this way.\"), mdx(\"p\", null, \"I hope to have JsPerf tests and an expanded API for my next post. Until then, I'll leave you with the full example code:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js\"\n  }), \"var initDb = (function() {\\n var name, version, db, connectPromise, upgradeIsRequired = false;\\n var schemaScripts = \\\\[\\\\];\\n\\n var connect = function(dbName, dbVersion, dbOnUpgrade) {\\n  upgradeIsRequired = (!connectPromise || dbName !== name || dbVersion !== version);\\n  if(upgradeIsRequired) {\\n   var deferred = Q.defer();\\n\\n   connectPromise = deferred.promise;\\n\\n    version = dbVersion || 1;\\n    name = dbName;\\n    dbOnUpgrade = dbOnUpgrade || function() {};\\n\\n    var request = window.indexedDB.open(name, version);\\n\\n    request.onblocked = function(event) {\\n     db.close();\\n     alert(\\\"A new version of this page is ready. Please reload!\\\");\\n    };\\n\\n    request.onerror = function(event) {\\n     deferred.reject(new Error(\\\"Database error: \\\" + event.target.errorCode));\\n     if(db) {\\n      db.close();\\n     }\\n    };\\n    request.onsuccess = function(event) {\\n     db = request.result;\\n     deferred.resolve(db);\\n    };\\n    request.onupgradeneeded = function(event) {\\n     db = event.target.result;\\n\\n     if(schemaScripts.length > 0) {\\n      n$.each(schemaScripts, function(script) {\\n       //debugger;\\n       script(db);\\n      });\\n     }\\n\\n     dbOnUpgrade(db);\\n    };\\n\\n\\n  }\\n  return connectPromise;\\n };\\n\\n var disconnect = function() {\\n  if(connectPromise.isFulfilled()) {\\n   db.close();\\n  } else if(db) {\\n   connectPromise.done(db.close);\\n  }\\n };\\n\\n var createTableImpl = function(dbWrapper, db, tableName, tablePkColumnName, autoIncrement) {\\n  var table = db.createObjectStore(tableName, { keyPath: tablePkColumnName, autoIncrement: false !== autoIncrement });\\n  dbWrapper.schema.add(tableName, table);\\n  return table;\\n };\\n\\n var createTable = function(dbWrapper, tableName, tablePkColumnName, autoIncrement) {\\n  var deferred = Q.defer();\\n  schemaScripts.push(function(db) {\\n   try {\\n    var objectStore = createTableImpl(dbWrapper, db, tableName, tablePkColumnName, autoIncrement);\\n    deferred.resolve(objectStore);\\n\\n   } catch(e) {\\n    console.log(e, e.stack);\\n    deferred.reject(new Error('Could not create a new table', e));\\n   }\\n   return dbWrapper.schema\\\\[tableName\\\\];\\n  });\\n  return deferred.promise;\\n };\\n\\n var createIndexImpl = function(dbWrapper, tableName, columnName, indexName, isUnique) {\\n  var table = dbWrapper.schema\\\\[tableName\\\\];\\n  return table.createIndex(columnName, indexName || columnName + 'Idx', { unique: true !== isUnique });\\n };\\n\\n var createIndex = function(dbWrapper, tableName, columnName, indexName, isUnique) {\\n  var deferred = Q.defer();\\n\\n  schemaScripts.push(function() {\\n   try {\\n    var index = createIndexImpl(dbWrapper, tableName, columnName, indexName, isUnique);\\n    deferred.resolve(index);\\n\\n   } catch(e) {\\n    console.log(e, e.stack);\\n    deferred.reject(new Error('Could not create a new index', e));\\n   }\\n   return dbWrapper.schema\\\\[tableName\\\\];\\n  });\\n  return deferred.promise;\\n };\\n\\n var insertImpl = function(tableName, records) {\\n  var deferred = Q.defer();\\n\\n  try {\\n   var transaction = db.transaction(\\\\[tableName\\\\], 'readwrite');\\n\\n   var objectStore = transaction.objectStore(tableName);\\n   n$.each(records, function(rec) {\\n    objectStore.add(rec);\\n   });\\n\\n   deferred.resolve(true);\\n  } catch(e) {\\n   console.log(e, e.stack);\\n   deferred.reject(new Error('Could not insert records',e));\\n  }\\n\\n  return deferred.promise;\\n };\\n\\n var insert = function(tableName, records) {\\n  var ret = function() {\\n   return insertImpl(tableName, records);\\n  };\\n  if(db || connectPromise.isResolved()) {\\n   ret();\\n  } else {\\n   connectPromise.then(ret);\\n  }\\n  //return ret.promise;\\n };\\n\\n return function() {\\n\\n  var ret = n$.object();\\n  ret.add('connect', connect);\\n  ret.add('disconnect', disconnect);\\n  ret.add('schema', n$.object());\\n  ret.add('ddl', {\\n   createTable: function(tableName, tablePkColumnName, autoIncrement) {\\n    var args = Array.prototype.slice.call(arguments, 0);\\n    args.unshift(ret);\\n    return createTable.apply(this, args);\\n   },\\n   dropTable: function(tableName) {\\n    var args = Array.prototype.slice.call(arguments, 0);\\n    args.unshift(ret);\\n    return createTable.apply(this, args);\\n   },\\n   createIndex: function(tableName, columnName, indexName, isUnique) {\\n    var args = Array.prototype.slice.call(arguments, 0);\\n    args.unshift(ret);\\n    return createIndex.apply(this, args);\\n   }\\n  });\\n  ret.add('insert', insert);\\n  return ret;\\n };\\n\\n}());\\n\")));\n}\n;\nMDXContent.isMDXComponent = true;","tableOfContents":{},"parent":{"__typename":"File","relativePath":"2013/a-promise-to-indexeddb.md"},"frontmatter":{"metaTitle":"A Promise to IndexedDb","metaDescription":null,"metaDate":"6/26/2013"}},"allMdx":{"edges":[{"node":{"fields":{"slug":"/2000/adjustments","title":"adjustments"}}},{"node":{"fields":{"slug":"/","title":"Welcome"}}},{"node":{"fields":{"slug":"/2000/beneath","title":"beneath"}}},{"node":{"fields":{"slug":"/2000/blastphemy","title":"blastphemy"}}},{"node":{"fields":{"slug":"/2000/earnest","title":"earnest"}}},{"node":{"fields":{"slug":"/2000/in-end","title":"in the end"}}},{"node":{"fields":{"slug":"/2000/mistake","title":"mistake"}}},{"node":{"fields":{"slug":"/2000/on-bubbles","title":"on bubbles"}}},{"node":{"fields":{"slug":"/2000/linger","title":"linger"}}},{"node":{"fields":{"slug":"/2000/parched","title":"parched"}}},{"node":{"fields":{"slug":"/2000/time-sensitive","title":"time sensitive"}}},{"node":{"fields":{"slug":"/2003/cig_russian","title":"Can''t Talk No Jive"}}},{"node":{"fields":{"slug":"/2000/toes","title":"toes"}}},{"node":{"fields":{"slug":"/2003/purged-by-fire","title":"Purged By Fire"}}},{"node":{"fields":{"slug":"/2003/one-last-hoorah","title":"One Last Hoorah"}}},{"node":{"fields":{"slug":"/2003/story-of-boy-and-his-ambition","title":"The Enemy (AKA Those Who Have Been Liberated) Revisited metaTitle: "}}},{"node":{"fields":{"slug":"/2003/the-swift-hand-of-the-enemy","title":"The Swift Hand of The Enemy (AKA Those Who Have Been Liberated)"}}},{"node":{"fields":{"slug":"/2003/wishing-wells-away","title":"Wishing Wells Away"}}},{"node":{"fields":{"slug":"/2003/war-against-the-enemy","title":"War Against the Enemy (AKA Those Who Have Been Liberated)"}}},{"node":{"fields":{"slug":"/2002/in-title","title":"In Title"}}},{"node":{"fields":{"slug":"/2005/fellow-thebans","title":"Fellow Thebans"}}},{"node":{"fields":{"slug":"/2005/great-tidings","title":"Great Tidings"}}},{"node":{"fields":{"slug":"/2005/eves-and-cusps","title":"Eves and Cusps"}}},{"node":{"fields":{"slug":"/2005/i-fought-giant-lizard-today","title":"I fought the giant lizard today"}}},{"node":{"fields":{"slug":"/2005/i-must-have-some-repressed-self","title":"\"W\"it"}}},{"node":{"fields":{"slug":"/2005/obo-mne","title":"обо мне"}}},{"node":{"fields":{"slug":"/2005/peanut-butter-and-sasquatch","title":"Peanut Butter and Sasquatch"}}},{"node":{"fields":{"slug":"/2006/bait","title":"Bait."}}},{"node":{"fields":{"slug":"/2006/can-see-my-tale","title":"can''t see my tale"}}},{"node":{"fields":{"slug":"/2006/elastic-vengeance","title":"elastic vengeance"}}},{"node":{"fields":{"slug":"/2006/lampshade-of-apocalypse","title":"lampshade of the apocalypse"}}},{"node":{"fields":{"slug":"/2006/see-to-shining-see","title":"See to Shining See"}}},{"node":{"fields":{"slug":"/2006/sea-of-rage","title":"Sea of Rage"}}},{"node":{"fields":{"slug":"/2006/rejected-personal-description-from-yahoo","title":"Rejected Personal Description from Yahoo"}}},{"node":{"fields":{"slug":"/2008/a-dark-in-shot","title":"a dark in the shot"}}},{"node":{"fields":{"slug":"/2006/this-country-does-not-exist","title":"this country does noT exist"}}},{"node":{"fields":{"slug":"/2006/tails-of-apocalypse","title":"tails of the apocalypse"}}},{"node":{"fields":{"slug":"/2008/a-comment-on-comments","title":"a comment on comments"}}},{"node":{"fields":{"slug":"/2008/a-man-and-his-economy","title":"a man and his economy"}}},{"node":{"fields":{"slug":"/2008/a-grieved-grievance","title":"a grieved grievance"}}},{"node":{"fields":{"slug":"/2008/blief-or-belf","title":"blief or belf"}}},{"node":{"fields":{"slug":"/2008/a-moral-comments","title":"a moral"}}},{"node":{"fields":{"slug":"/2008/a-moral","title":"a moral"}}},{"node":{"fields":{"slug":"/2008/burning-bush","title":"burning bush"}}},{"node":{"fields":{"slug":"/2008/circles-twice-removed","title":"circles twice removed"}}},{"node":{"fields":{"slug":"/2008/eli-my-eli","title":"Eli, my Eli"}}},{"node":{"fields":{"slug":"/2008/awesome-pitiable-envy","title":"awesome pitiable envy"}}},{"node":{"fields":{"slug":"/2008/for-your-bucket-of-thoughts","title":"for your bucket of thoughts"}}},{"node":{"fields":{"slug":"/2008/hogwash","title":"hogwash"}}},{"node":{"fields":{"slug":"/2008/goodybye-randy-pausch","title":"Goodybye Randy Pausch "}}},{"node":{"fields":{"slug":"/2008/full-disclosure","title":"full disclosure"}}},{"node":{"fields":{"slug":"/2008/hello-son","title":"hello, son"}}},{"node":{"fields":{"slug":"/2008/i-love-twine","title":"i love twine"}}},{"node":{"fields":{"slug":"/2008/i-pity-them","title":"i pity them"}}},{"node":{"fields":{"slug":"/2008/in-waking-hours","title":"in the waking hours"}}},{"node":{"fields":{"slug":"/2008/license-to-hit","title":"License to *hit"}}},{"node":{"fields":{"slug":"/2008/like-father-like-father","title":"like father like father"}}},{"node":{"fields":{"slug":"/2008/over-hill-and-through-woods","title":"over the hill and through the woods"}}},{"node":{"fields":{"slug":"/2008/out-of-mind-of-sight","title":"out of mind of sight"}}},{"node":{"fields":{"slug":"/2008/thanksgiving","title":"Thanksgiving"}}},{"node":{"fields":{"slug":"/2008/shine-and-rise","title":"shine and rise"}}},{"node":{"fields":{"slug":"/2008/presidential-politics-aside","title":"presidential politics aside"}}},{"node":{"fields":{"slug":"/2008/the-folly-of-age","title":"the folly of age"}}},{"node":{"fields":{"slug":"/2008/the-blackess-of-winter","title":"the blackess of winter"}}},{"node":{"fields":{"slug":"/2008/this-present-opaqueness","title":"this present opaqueness"}}},{"node":{"fields":{"slug":"/2004/area-man-blows-second-chance-at-life","title":"Area Man Blows Second Chance at Life, Hopes for Third"}}},{"node":{"fields":{"slug":"/2008/unleash-space","title":"unleash the space"}}},{"node":{"fields":{"slug":"/2004/area-man-confused-by-obscure-references","title":"Area Man Confused By Obscure \"Mullis\" References"}}},{"node":{"fields":{"slug":"/2004/baal-is-dead-i-killed-him","title":"Baal is Dead; I Killed Him"}}},{"node":{"fields":{"slug":"/2004/local-news","title":"Local News"}}},{"node":{"fields":{"slug":"/2004/local-news_9","title":"Local News"}}},{"node":{"fields":{"slug":"/2004/public-concern-rises-as-treatment-of","title":"Public Concern Rises as Treatment of Prisoners Declines"}}},{"node":{"fields":{"slug":"/2009/eli-walks","title":"Eli Walks"}}},{"node":{"fields":{"slug":"/2004/yes","title":"Yes!"}}},{"node":{"fields":{"slug":"/2009/palin-should-have-won","title":"palin should have won"}}},{"node":{"fields":{"slug":"/2009/meeting_melchilzedek","title":"Meeting Melchilzedek"}}},{"node":{"fields":{"slug":"/2009/something-worth-sharing","title":"something worth sharing"}}},{"node":{"fields":{"slug":"/2009/wishing-and-unwishing","title":"wishing and unwishing"}}},{"node":{"fields":{"slug":"/2007/bush-repunctuates-education-law-child","title":"Bush Repunctuates Education Law: \"No! Child... 'Left Behind'?\" Act"}}},{"node":{"fields":{"slug":"/2009/year-new","title":"year, new"}}},{"node":{"fields":{"slug":"/2007/automakers-propose-cutting-emisions-in","title":"Automakers Propose Cutting Emisions in Half by Releasing Only Pure, Clean Carbon-Monoxide"}}},{"node":{"fields":{"slug":"/2007/cbs-introduces-on-demand","title":"CBS Introduces \"Life on Demand\""}}},{"node":{"fields":{"slug":"/2007/concerns-rise-as-expectations-lower","title":"Concerns Rise as Expectations Lower"}}},{"node":{"fields":{"slug":"/2007/defer","title":"defer"}}},{"node":{"fields":{"slug":"/2007/fallujah","title":"Fallujah"}}},{"node":{"fields":{"slug":"/2007/glope","title":"glope"}}},{"node":{"fields":{"slug":"/2007/greek-god-vows-to-avenge-son-death","title":"Greek God Vows to Avenge Son''s Death"}}},{"node":{"fields":{"slug":"/2007/forgotten-futures","title":"forgotten futures"}}},{"node":{"fields":{"slug":"/2007/its_that_time_when_the_world_falls_in_love","title":"It's that time when the world falls in love"}}},{"node":{"fields":{"slug":"/2007/laziness-breeds","title":"laziness breeds"}}},{"node":{"fields":{"slug":"/2007/open-p2p-peer-to-peer-to-life","title":"Open P2P (Peer to Peer) to Life"}}},{"node":{"fields":{"slug":"/2007/pope-announces-begins-at-lust","title":"Pope Announces: \"Life Begins at Lust\""}}},{"node":{"fields":{"slug":"/2007/pope-announces-revolutionary-only","title":"Pope Announces Revolutionary \"Abstinence Only Education\""}}},{"node":{"fields":{"slug":"/2007/put-these-into-my-car","title":"Put These Into My Car"}}},{"node":{"fields":{"slug":"/2007/quit-me-thisly","title":"quit me thisly"}}},{"node":{"fields":{"slug":"/2007/thought-in-progress","title":"thought in progress"}}},{"node":{"fields":{"slug":"/2007/thurgling","title":"thurgling"}}},{"node":{"fields":{"slug":"/2010/alas","title":"alas"}}},{"node":{"fields":{"slug":"/2010/if-it-looks-like-duck-and-walks-like","title":"if it looks like a duck and walks like a duck, let''s call it a moose"}}},{"node":{"fields":{"slug":"/2010/vancouver-winter-olympics-2010","title":"Vancouver! Winter! Olympics! 2010!"}}},{"node":{"fields":{"slug":"/2012/complex-units-of-measure","title":"Complex Units of Measure"}}},{"node":{"fields":{"slug":"/2012/how-to-subclass-array-not-really","title":"How to Subclass an Array (Not Really)"}}},{"node":{"fields":{"slug":"/2012/on-competence","title":"On Competence"}}},{"node":{"fields":{"slug":"/2012/communicating-and-why-i-quit-email","title":"Communicating and Why I Quit Email (Episode 1)"}}},{"node":{"fields":{"slug":"/2012/performance-determinism-vs","title":"Performance! Determinism. Vs?"}}},{"node":{"fields":{"slug":"/2012/out_with_the_old_in_with_the_new_profile","title":"Out With the Old, In With the New (Profile)"}}},{"node":{"fields":{"slug":"/2012/physical-books-and-such","title":"Physical Books (and Such)"}}},{"node":{"fields":{"slug":"/2012/the-cost-of-urgency","title":"The Cost of Urgency"}}},{"node":{"fields":{"slug":"/2012/your-hyperbole-is-too-large","title":"Your Hyperbole is Too Large"}}},{"node":{"fields":{"slug":"/2011/bubonics","title":"Affectation Without Action"}}},{"node":{"fields":{"slug":"/2011/equipment-failure","title":"Equipment Failure"}}},{"node":{"fields":{"slug":"/2011/how-to-build-mountain","title":"How to Build a Mountain"}}},{"node":{"fields":{"slug":"/2011/remember-to-look-up-and-write-down","title":"Remember to Look Up and Write Down"}}},{"node":{"fields":{"slug":"/2011/one-man-hiking-his-desk-makes-journey","title":"One Man Hiking His Desk Makes a Journey. Two Men Hiking Makes a Race."}}},{"node":{"fields":{"slug":"/2011/seeing-tree-for-forest","title":"Seeing the Tree for the Forest"}}},{"node":{"fields":{"slug":"/2011/the-audacity-of-despair","title":"The Audacity of Despair"}}},{"node":{"fields":{"slug":"/2011/some-people-climb-everest-i-hike-my","title":"Some People Climb Everest; I Hike My Desk"}}},{"node":{"fields":{"slug":"/2011/sir-george-mountain","title":"Sir George Mountain"}}},{"node":{"fields":{"slug":"/2011/this-is-end-of-world","title":"this is the end of the world"}}},{"node":{"fields":{"slug":"/2011/trail-mix","title":"Trail Mix"}}},{"node":{"fields":{"slug":"/2011/washed-up-on-shore-of-this-morning","title":"washed up on the shore of this morning"}}},{"node":{"fields":{"slug":"/2013/api-documentation-considered-evil","title":"From JsDoc to Github Pages in 27 easy steps (aka API Documentation Considered Evil)?"}}},{"node":{"fields":{"slug":"/2013/a-promise-to-indexeddb","title":"A Promise to IndexedDb"}}},{"node":{"fields":{"slug":"/2013/crunchy-frog-comments","title":"Crunchy Frog"}}},{"node":{"fields":{"slug":"/2013/god-probably-probably-doesnt-use-your","title":"God Probably, *Probably*, Doesn''t Use Your App"}}},{"node":{"fields":{"slug":"/2013/crunchy-frog","title":"Crunchy Frog"}}},{"node":{"fields":{"slug":"/2013/good-reads","title":"Good Reads"}}},{"node":{"fields":{"slug":"/2013/keeping-promise-to-indexeddb","title":"Keeping a Promise to IndexedDb"}}},{"node":{"fields":{"slug":"/2013/javascript-aka-marlboro-country","title":"JavaScript (aka Marlboro Country)"}}},{"node":{"fields":{"slug":"/2013/revisiting-how-to-subclass-array-really","title":"Revisiting metaTitle: "}}},{"node":{"fields":{"slug":"/2013/currying-favor-with-partial-application","title":"Currying Favor with Partial Application to get JavaScript SQL"}}},{"node":{"fields":{"slug":"/2013/making-sense-of-grunt-importing","title":"Making Sense of Grunt metaTitle: "}}},{"node":{"fields":{"slug":"/2013/stealing-trillion-dollars-hour-in-pure","title":"Stealing a Trillion Dollars an Hour in Pure JavaScript"}}},{"node":{"fields":{"slug":"/2013/the-greatest-heist-ever-conceived","title":"The Greatest Heist Ever Conceived"}}},{"node":{"fields":{"slug":"/2013/the-audacity-of-trying","title":"The Audacity of Trying"}}},{"node":{"fields":{"slug":"/2013/the-quick-molting-sweat-lodge-of-soul","title":"The Quick, Molting Sweat Lodge of the Soul"}}},{"node":{"fields":{"slug":"/2013/the-single-arity-aka-communicating-and","title":"The Single Arity (aka Communicating and why I Quit Email metaTitle: "}}},{"node":{"fields":{"slug":"/1998/lamplight","title":"Lamplight"}}},{"node":{"fields":{"slug":"/1998/mollie","title":"Mollie"}}},{"node":{"fields":{"slug":"/1998/mussel","title":"Mussel"}}},{"node":{"fields":{"slug":"/2020/blogging_to_the_oldies","title":"Blogging to the Oldies"}}},{"node":{"fields":{"slug":"/2020/oscar","title":"Oscar"}}}]}},"pageContext":{"id":"7dd5c599-2016-5705-931f-86516bb740b9"}},"staticQueryHashes":["2221665114","2221665114","3706406642","3706406642","417421954","417421954"]}